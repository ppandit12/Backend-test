<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trello Clone</title>
    <style>
      :root {
        --primary: #0079bf;
        --primary-dark: #026aa7;
        --secondary: #5aac44;
        --bg-dark: #0079bf;
        --bg-light: #f4f5f7;
        --card-bg: #fff;
        --list-bg: #ebecf0;
        --text-primary: #172b4d;
        --text-secondary: #5e6c84;
        --danger: #eb5a46;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info .badge {
        background: var(--secondary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        text-transform: uppercase;
      }

      .user-info .badge.premium {
        background: #f2d600;
        color: #172b4d;
      }

      /* Auth Forms */
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 100px);
        padding: 2rem;
      }

      .auth-card {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .auth-card h2 {
        text-align: center;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #dfe1e6;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-secondary {
        background: var(--list-bg);
        color: var(--text-primary);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }

      .auth-toggle {
        text-align: center;
        margin-top: 1rem;
        color: var(--text-secondary);
      }

      .auth-toggle a {
        color: var(--primary);
        text-decoration: none;
      }

      .error-msg {
        background: #ffebe6;
        color: var(--danger);
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }

      /* Board List */
      .boards-container {
        padding: 2rem;
      }

      .boards-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        color: white;
      }

      .boards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }

      .board-card {
        background: linear-gradient(135deg, #0079bf 0%, #5067c5 100%);
        border-radius: 8px;
        padding: 1rem;
        color: white;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        min-height: 100px;
        position: relative;
      }

      .board-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }

      .board-card.new-board {
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        border: 2px dashed rgba(255, 255, 255, 0.5);
      }

      .board-card h3 {
        font-weight: 600;
      }

      .board-card .delete-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .board-card:hover .delete-btn {
        opacity: 1;
      }

      /* Board View */
      .board-view {
        height: calc(100vh - 60px);
        overflow-x: auto;
        padding: 1rem;
      }

      .board-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        color: white;
      }

      .board-header h2 {
        font-weight: 700;
      }

      .lists-container {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        min-height: calc(100vh - 150px);
      }

      .list {
        background: var(--list-bg);
        border-radius: 8px;
        width: 280px;
        flex-shrink: 0;
        max-height: calc(100vh - 150px);
        display: flex;
        flex-direction: column;
      }

      .list-header {
        padding: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .list-header h4 {
        font-weight: 600;
        color: var(--text-primary);
      }

      .list-cards {
        padding: 0 0.5rem;
        overflow-y: auto;
        flex: 1;
      }

      .card {
        background: var(--card-bg);
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s;
      }

      .card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .card-title {
        color: var(--text-primary);
        font-size: 0.875rem;
      }

      .card-meta {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .card-badge {
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .card-badge.due-date {
        background: #fcf3c0;
        color: #6b5600;
      }

      .card-badge.due-date.overdue {
        background: var(--danger);
        color: white;
      }

      .card-badge.attachments {
        background: #dfe1e6;
        color: var(--text-secondary);
      }

      .add-card-btn,
      .add-list-btn {
        padding: 0.75rem;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .add-card-btn:hover,
      .add-list-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .add-list {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        width: 280px;
        flex-shrink: 0;
        padding: 0.75rem;
        color: white;
        cursor: pointer;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 5vh;
        z-index: 100;
      }

      .modal {
        background: white;
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #dfe1e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        color: var(--text-primary);
      }

      .modal-body {
        padding: 1rem;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
      }

      .hidden {
        display: none !important;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 2rem;
        color: white;
      }

      /* Attachments */
      .attachments-list {
        margin-top: 1rem;
      }

      .attachment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: var(--bg-light);
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }

      .attachment-item a {
        color: var(--primary);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>üìã Trello Clone</h1>
      <div id="userInfo" class="user-info hidden"></div>
    </header>

    <main id="app">
      <!-- Auth Container -->
      <div id="authContainer" class="auth-container">
        <div class="auth-card">
          <div id="loginForm">
            <h2>Log In</h2>
            <div id="loginError" class="error-msg hidden"></div>
            <form onsubmit="handleLogin(event)">
              <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" required />
              </div>
              <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required />
              </div>
              <button type="submit" class="btn btn-primary">Log In</button>
            </form>
            <p class="auth-toggle">
              Don't have an account?
              <a href="#" onclick="showRegister()">Sign up</a>
            </p>
          </div>

          <div id="registerForm" class="hidden">
            <h2>Create Account</h2>
            <div id="registerError" class="error-msg hidden"></div>
            <form onsubmit="handleRegister(event)">
              <div class="form-group">
                <label for="registerName">Name</label>
                <input type="text" id="registerName" required />
              </div>
              <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" required />
              </div>
              <div class="form-group">
                <label for="registerPassword">Password</label>
                <input
                  type="password"
                  id="registerPassword"
                  minlength="6"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Create Account
              </button>
            </form>
            <p class="auth-toggle">
              Already have an account?
              <a href="#" onclick="showLogin()">Log in</a>
            </p>
          </div>
        </div>
      </div>

      <!-- Boards Container -->
      <div id="boardsContainer" class="boards-container hidden">
        <div class="boards-header">
          <h2>Your Boards</h2>
          <button onclick="logout()" class="btn btn-secondary btn-small">
            Logout
          </button>
        </div>
        <div id="boardsGrid" class="boards-grid"></div>
      </div>

      <!-- Board View -->
      <div id="boardView" class="board-view hidden">
        <div class="board-header">
          <button onclick="goBack()" class="btn btn-secondary btn-small">
            ‚Üê Back
          </button>
          <h2 id="boardTitle"></h2>
        </div>
        <div id="listsContainer" class="lists-container"></div>
      </div>
    </main>

    <!-- Card Modal -->
    <div id="cardModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3 id="cardModalTitle">Card Details</h3>
          <button class="modal-close" onclick="closeCardModal()">√ó</button>
        </div>
        <div class="modal-body">
          <form id="cardForm">
            <div class="form-group">
              <label>Title</label>
              <input type="text" id="cardTitle" required />
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea
                id="cardDescription"
                rows="4"
                style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid #dfe1e6;
                  border-radius: 4px;
                  font-family: inherit;
                  resize: vertical;
                "
              ></textarea>
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="datetime-local" id="cardDueDate" />
            </div>
            <div class="form-group">
              <label>Move to List</label>
              <select
                id="cardMoveList"
                style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid #dfe1e6;
                  border-radius: 4px;
                "
              ></select>
            </div>
            <div id="attachmentsSection">
              <label>Attachments</label>
              <div id="attachmentsList" class="attachments-list"></div>
              <input
                type="file"
                id="attachmentInput"
                style="margin-top: 0.5rem"
              />
              <button
                type="button"
                onclick="uploadAttachment()"
                class="btn btn-secondary btn-small"
                style="margin-top: 0.5rem"
              >
                Upload
              </button>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
              <button type="submit" class="btn btn-primary">Save</button>
              <button
                type="button"
                onclick="deleteCard()"
                class="btn btn-danger"
              >
                Delete
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // State
      let token = localStorage.getItem("token");
      let user = null;
      let currentBoard = null;
      let currentCard = null;

      const API = "/api";

      // API helpers
      async function api(endpoint, options = {}) {
        const headers = { "Content-Type": "application/json" };
        if (token) headers["Authorization"] = `Bearer ${token}`;

        const res = await fetch(`${API}${endpoint}`, {
          ...options,
          headers: { ...headers, ...options.headers },
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || "Request failed");
        }

        return res.json();
      }

      // Auth
      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const data = await api("/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          token = data.token;
          user = data.user;
          localStorage.setItem("token", token);
          showBoards();
        } catch (err) {
          document.getElementById("loginError").textContent = err.message;
          document.getElementById("loginError").classList.remove("hidden");
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        const name = document.getElementById("registerName").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        try {
          const data = await api("/auth/register", {
            method: "POST",
            body: JSON.stringify({ name, email, password }),
          });

          token = data.token;
          user = data.user;
          localStorage.setItem("token", token);
          showBoards();
        } catch (err) {
          document.getElementById("registerError").textContent = err.message;
          document.getElementById("registerError").classList.remove("hidden");
        }
      }

      function logout() {
        token = null;
        user = null;
        localStorage.removeItem("token");
        showAuth();
      }

      function showLogin() {
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("registerForm").classList.add("hidden");
      }

      function showRegister() {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("registerForm").classList.remove("hidden");
      }

      function showAuth() {
        document.getElementById("authContainer").classList.remove("hidden");
        document.getElementById("boardsContainer").classList.add("hidden");
        document.getElementById("boardView").classList.add("hidden");
        document.getElementById("userInfo").classList.add("hidden");
      }

      // Boards
      async function showBoards() {
        document.getElementById("authContainer").classList.add("hidden");
        document.getElementById("boardsContainer").classList.remove("hidden");
        document.getElementById("boardView").classList.add("hidden");

        // Get user info
        const userData = await api("/auth/me");
        user = userData.user;

        document.getElementById("userInfo").classList.remove("hidden");
        document.getElementById("userInfo").innerHTML = `
                <span>${user.name}</span>
                <span class="badge ${user.accountType === "premium" ? "premium" : ""}">${user.accountType}</span>
                ${user.accountType === "free" ? '<button onclick="upgrade()" class="btn btn-small" style="background:#f2d600;color:#172b4d;">Upgrade</button>' : ""}
            `;

        await loadBoards();
      }

      async function loadBoards() {
        const data = await api("/boards");
        const grid = document.getElementById("boardsGrid");

        grid.innerHTML =
          data.boards
            .map(
              (b) => `
                <div class="board-card" onclick="openBoard(${b.id})">
                    <h3>${escapeHtml(b.name)}</h3>
                    ${b.description ? `<p style="font-size:0.875rem;opacity:0.9;margin-top:0.5rem;">${escapeHtml(b.description)}</p>` : ""}
                    <button class="delete-btn" onclick="deleteBoard(event, ${b.id})">√ó</button>
                </div>
            `,
            )
            .join("") +
          `
                <div class="board-card new-board" onclick="createBoard()">+</div>
            `;
      }

      async function createBoard() {
        const name = prompt("Enter board name:");
        if (!name) return;

        try {
          await api("/boards", {
            method: "POST",
            body: JSON.stringify({ name }),
          });
          await loadBoards();
        } catch (err) {
          alert(err.message);
        }
      }

      async function deleteBoard(e, id) {
        e.stopPropagation();
        if (!confirm("Delete this board?")) return;

        await api(`/boards/${id}`, { method: "DELETE" });
        await loadBoards();
      }

      async function upgrade() {
        if (!confirm("Upgrade to premium?")) return;
        await api("/auth/upgrade", { method: "PATCH" });
        await showBoards();
      }

      // Board View
      async function openBoard(id) {
        document.getElementById("boardsContainer").classList.add("hidden");
        document.getElementById("boardView").classList.remove("hidden");

        const data = await api(`/boards/${id}`);
        currentBoard = data.board;

        document.getElementById("boardTitle").textContent = currentBoard.name;
        renderLists();
      }

      function renderLists() {
        const container = document.getElementById("listsContainer");

        container.innerHTML =
          currentBoard.lists
            .map(
              (list) => `
                <div class="list" data-list-id="${list.id}">
                    <div class="list-header">
                        <h4>${escapeHtml(list.name)}</h4>
                        <button onclick="deleteList(${list.id})" style="background:none;border:none;cursor:pointer;color:#5e6c84;">√ó</button>
                    </div>
                    <div class="list-cards">
                        ${list.cards.map((card) => renderCard(card)).join("")}
                    </div>
                    <div class="add-card-btn" onclick="createCard(${list.id})">+ Add a card</div>
                </div>
            `,
            )
            .join("") +
          `
                <div class="add-list" onclick="createList()">+ Add another list</div>
            `;
      }

      function renderCard(card) {
        const dueDate = card.due_date ? new Date(card.due_date) : null;
        const isOverdue = dueDate && dueDate < new Date();

        return `
                <div class="card" onclick="openCard(${card.id})">
                    <div class="card-title">${escapeHtml(card.title)}</div>
                    <div class="card-meta">
                        ${dueDate ? `<span class="card-badge due-date ${isOverdue ? "overdue" : ""}">üìÖ ${dueDate.toLocaleDateString()}</span>` : ""}
                        ${card.attachment_count > 0 ? `<span class="card-badge attachments">üìé ${card.attachment_count}</span>` : ""}
                    </div>
                </div>
            `;
      }

      async function createList() {
        const name = prompt("Enter list name:");
        if (!name) return;

        await api(`/boards/${currentBoard.id}/lists`, {
          method: "POST",
          body: JSON.stringify({ name }),
        });
        await openBoard(currentBoard.id);
      }

      async function deleteList(id) {
        if (!confirm("Delete this list?")) return;
        await api(`/lists/${id}`, { method: "DELETE" });
        await openBoard(currentBoard.id);
      }

      async function createCard(listId) {
        const title = prompt("Enter card title:");
        if (!title) return;

        await api(`/lists/${listId}/cards`, {
          method: "POST",
          body: JSON.stringify({ title }),
        });
        await openBoard(currentBoard.id);
      }

      // Card Modal
      async function openCard(id) {
        const data = await api(`/cards/${id}`);
        currentCard = data.card;

        document.getElementById("cardTitle").value = currentCard.title;
        document.getElementById("cardDescription").value =
          currentCard.description || "";
        document.getElementById("cardDueDate").value = currentCard.due_date
          ? new Date(currentCard.due_date).toISOString().slice(0, 16)
          : "";

        // Populate list selector
        const listSelect = document.getElementById("cardMoveList");
        listSelect.innerHTML = currentBoard.lists
          .map(
            (l) =>
              `<option value="${l.id}" ${l.id === currentCard.list_id ? "selected" : ""}>${escapeHtml(l.name)}</option>`,
          )
          .join("");

        // Render attachments
        renderAttachments();

        document.getElementById("cardModal").classList.remove("hidden");
        document.getElementById("cardForm").onsubmit = saveCard;
      }

      function renderAttachments() {
        const container = document.getElementById("attachmentsList");
        container.innerHTML =
          currentCard.attachments
            .map(
              (a) => `
                <div class="attachment-item">
                    <a href="/uploads/${a.filename}" target="_blank">${escapeHtml(a.original_name)}</a>
                    <button onclick="deleteAttachment(${a.id})" class="btn btn-danger btn-small">√ó</button>
                </div>
            `,
            )
            .join("") ||
          '<p style="color:#5e6c84;font-size:0.875rem;">No attachments</p>';
      }

      async function saveCard(e) {
        e.preventDefault();

        const title = document.getElementById("cardTitle").value;
        const description = document.getElementById("cardDescription").value;
        const dueDate = document.getElementById("cardDueDate").value || null;
        const newListId = parseInt(
          document.getElementById("cardMoveList").value,
        );

        await api(`/cards/${currentCard.id}`, {
          method: "PATCH",
          body: JSON.stringify({ title, description, dueDate }),
        });

        // Move if list changed
        if (newListId !== currentCard.list_id) {
          await api(`/cards/${currentCard.id}/move`, {
            method: "PATCH",
            body: JSON.stringify({ listId: newListId, position: 0 }),
          });
        }

        closeCardModal();
        await openBoard(currentBoard.id);
      }

      async function deleteCard() {
        if (!confirm("Delete this card?")) return;
        await api(`/cards/${currentCard.id}`, { method: "DELETE" });
        closeCardModal();
        await openBoard(currentBoard.id);
      }

      async function uploadAttachment() {
        const fileInput = document.getElementById("attachmentInput");
        if (!fileInput.files[0]) return;

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const res = await fetch(`${API}/cards/${currentCard.id}/attachments`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });

        if (!res.ok) {
          const err = await res.json();
          alert(err.error);
          return;
        }

        // Refresh card
        const data = await api(`/cards/${currentCard.id}`);
        currentCard = data.card;
        renderAttachments();
        fileInput.value = "";
      }

      async function deleteAttachment(id) {
        await api(`/cards/${currentCard.id}/attachments/${id}`, {
          method: "DELETE",
        });
        const data = await api(`/cards/${currentCard.id}`);
        currentCard = data.card;
        renderAttachments();
      }

      function closeCardModal() {
        document.getElementById("cardModal").classList.add("hidden");
        currentCard = null;
      }

      function goBack() {
        currentBoard = null;
        showBoards();
      }

      // Helpers
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Init
      if (token) {
        showBoards().catch(() => showAuth());
      } else {
        showAuth();
      }
    </script>
  </body>
</html>
